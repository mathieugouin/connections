<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

        <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1, maximum-scale=1, user-scalable=no">

        <meta name="description" content="Connections board game">

        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="mobile-web-app-capable" content="yes">

        <title>Connections</title>

        <script src="jquery-3.5.1.js" />

        <style>
            body {
              margin: 0;
            }

            div {
              position: absolute;
              text-align: center;
            }

            @media (orientation:portrait) and (min-aspect-ratio: 2/3)  {
              #container {
                width: 66.6666666667vh;
                height: 100vh;
                top: 0;
                left:calc(50vw - 33.3333333333vh);
              }
              html {font-size: 2.5vh;}
            }

            @media (orientation:portrait) and (max-aspect-ratio: 2/3)  {
              #container {
                width: 100vw;
                height: 150vw;
                top: 0;
                left:0;
              }
              html {font-size: 3.75vw;}
            }

            @media (orientation:landscape) and (min-aspect-ratio: 3/2) {
              #container {
                width: 150vh;
                height: 100vh;
                top:0;
                left: calc(50vw - 75vh);
              }
              html {font-size: 3.75vh;}
            }

            @media (orientation:landscape) and (max-aspect-ratio: 3/2) {
              #container {
                width: 100vw;
                height: 66.6666666667vw;
                top: 0;
                left:0;
              }
              html {font-size: 2.5vw;}
            }

            @media (orientation:portrait) {
              #nav {
                left:0%;
                top:0%;
                width:100%;
                height:33.3333333333%;
              }
              #board {
                left:0;
                top: 33.3333333333%;
                width: 100%;
                height: 66.6666666667%;
              }
              #title {left:0%;top:0%; width:50%; height:20%;}
              #description {left:51.25%;top:0%; width:47.25%; height:60%;}
              #button_div {left:0%; top:20%; width:50%; height:80%;}
              #player_div {left:50%; top:60%; width:50%; height:40%;}
            }

            @media (orientation:landscape) {
              #nav {
                left: 0%;
                top:0%;
                width: 33.3333333333%;
                height:100%;
              }
              #board {
                left:33.3333333333%;
                top:0%;
                width: 66.6666666667%;
                height: 100%;
              }
              #title {left:0%; top:0%; width:100%; height:10%;}
              #description {left:2.5%;top:10%; width:95%; height:30%;}
              #button_div {left:0%; top:40%; width:100%; height:40%;}
              #player_div {left:0%; top:80%; width:100%; height:20%;}
            }

            #board {
              background-color: #555555;
            }

            #lang     {top:0%;}
            #about    {top:25%;}
            #new      {top:50%;}
            #back     {top:75%;}
            #player_1 {top:0%;}
            #player_2 {top:50%;}

            .button {
              position: absolute;
              width:75%;
              left:0;
              right:0;
              padding:0;
              margin: auto;
              height: 1.5em;
              line-height: 1.5em;
              font-weight: bold;
              border-style: solid;
              border-width: 0.2em;
              border-color: #8685a2;
              background-color: #a6a5c9;
              -webkit-border-radius: 1em;
              -moz-border-radius: 1em;
              border-radius: 0.5em;
              cursor: pointer;
              -moz-user-select: none;
              -webkit-user-select: none;
              -ms-user-select: none;
            }

            .active {
              opacity: 1;
            }

            .inactive {
              opacity: 0.50;
              border-color: #ffffff;
            }

            .languagepicker {
                z-index: 1;
                height: 1.5em;
                width:75%;
                overflow: hidden;
                transition: height .3s ease;
                vertical-align: top;
            }

            .languagepicker a{
                color: #000;
                text-decoration: none;
            }

            .languagepicker li {
                display: block;
                border-top: 0.05em solid #8685a2;
                background-color: #a6a5c9;
            }

            .languagepicker li:first-child {
                border: none;
                background-color: #a6a5c9;
            }

            @media (hover: none) {
              .languagepicker li:first-child a {
                pointer-events: none;
                cursor: default;
              }
            }

            .languagepicker:hover {
                /* don't forget the 0.05em border : nb_line*1.55 - 0.05 */
                height: 15.45em;
            }

            .languagepicker li img {
                margin-right: 0.5em;
                height: 0.75em;
            }

            .languagepicker li:hover {
                background-color:  #d3d3e4;
            }

            #description {
              text-align: left;
            }

            #player_1 {
              background-image:url(red.svg);
              background-size: 1.5em 1.5em;
              background-repeat: no-repeat;
              background-position:left center;
            }
            #player_2 {
              background-image:url(yellow.svg);
              background-size: 1.5em 1.5em;
              background-repeat: no-repeat;
              background-position:left center;
            }


            html {
              font-family: Arial, Helvetica, sans-serif;
            }

            h1 {
              font-size: 1.15em;
              font-weight: bold;
              margin: 0;
            }

            #solution_header {
              left:0;
              top: 85.714285714%;
              width:100%;
              height: 1em;
              line-height: 1em;
            }

            #solution {
              left:0;
              top: 90.476190476%;
              height:9.523809524%;
              width:100%;
            }

            #hide_solution_div {
              left:0;
              top: 90.476190476%;
              height:9.523809524%;
              width:100%;
              z-index: 50;
              background-color: white;
            }

            #about_div {
              top: 0;
              left: 0;
              padding: 2.5%;
              height: 100%;
              display: none;
              background-color: white;
              opacity: 0.95;
              z-index: 100;
              text-align: left;
              overflow-y:auto;
            }

            .board {
              height:calc(100% / 11);
              width:calc(100% / 11);
              z-index:2;
            }

            .board_pin_red {
              background-image:url(pin_red.svg);
              background-size: 100% 100%;
              background-repeat: no-repeat;
              height:calc(100% / 11);
              width:calc(100% / 11);
              z-index:2;
            }

            .board_pin_white {
              background-image:url(pin_white.svg);
              background-size: 100% 100%;
              background-repeat: no-repeat;
              height:calc(100% / 11);
              width:calc(100% / 11);
              z-index:2;
            }

            .solution {
              width: calc(100% / 7);
              height: 2em;
              line-height: 2em;
              background-image:none;
              background-size: contain;
              background-repeat: no-repeat;
              background-position: center;
            }

            .win {
              background-image:url(win.png);
              width:calc(100% / 7);
              height:calc(100% / 7);
              background-size: 100% 100%;
              background-repeat: no-repeat;
              z-index:1;
            }

            .player1 {
              background-image:url(red.svg);
              width:calc(100% / 11);
              height:calc(100% / 11);
              background-size: 100% 100%;
              background-repeat: no-repeat;
              z-index:0;
            }
            .player2 {
              background-image:url(white.svg);
              width:calc(100% / 11);
              height:calc(100% / 11);
              background-size: 100% 100%;
              background-repeat: no-repeat;
              z-index:0;
            }

            .player1h {
              background-image:url(red_h.svg);
              width:calc(100% / 11);
              height:calc(100% / 11);
              background-size: 100% 100%;
              background-repeat: no-repeat;
              z-index:0;
            }
            .player1v {
              background-image:url(red_v.svg);
              width:calc(100% / 11);
              height:calc(100% / 11);
              background-size: 100% 100%;
              background-repeat: no-repeat;
              z-index:0;
            }
            .player2h {
              background-image:url(white_h.svg);
              width:calc(100% / 11);
              height:calc(100% / 11);
              background-size: 100% 100%;
              background-repeat: no-repeat;
              z-index:0;
            }
            .player2v {
              background-image:url(white_v.svg);
              width:calc(100% / 11);
              height:calc(100% / 11);
              background-size: 100% 100%;
              background-repeat: no-repeat;
              z-index:0;
            }

        </style>

        <script type="text/javascript">
            //<![CDATA[

            // Connections
            var NB_ROW = 11;
            var NB_COL = 11;

            //var stone = [];
            var stone_h = []; // horizontal
            var stone_v = []; // vertical
            var mark = [];
            var height = [0, 0, 0, 0, 0, 0, 0];
            var moves = [];
            var solutions = [];
            var board = [
              [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
              [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
              [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
              [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
              [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
              [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
              [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
              [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
              [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
              [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
              [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
              ];

            var won = false;
            var player_1_auto = false;
            var player_2_auto = false;

            function auto_play() {
              if(moves.length % 2) return player_2_auto;
              else return player_1_auto;
            }

            function canplay(row, col) {
              return board[row][col] == 0;
            }

            function play(row, col) {
              board[row][col] = 1 + moves.length % 2;
              if (isEven(row) && isEven(col) && isEven(moves.length) ||
                  isOdd(row) && isOdd(col) && isOdd(moves.length)) {
                drop(stone_v[moves.length], row, col);
              } else {
                drop(stone_h[moves.length], row, col);
              }
              
              moves.push(1000 * row + col);
              //win();
              //window.history.replaceState(null, null, get_pos_param());
              //if(dont_compute) return;
              //print_solution();
            }

            function click_handler(row, col) {
              return function () {
                console.info("click on " + row + " " + col);
                if (canplay(row, col)) {
                  play(row, col);
                } else {
                  console.warn("canot play on " + row + " " + col);
                }
              };
            }

            function print_next_player() {
              if(won) {
                $("#player_1").removeClass("active").addClass("inactive");
                $("#player_2").removeClass("active").addClass("inactive");
              }
              else if(moves.length % 2 == 0) {
                $("#player_1").removeClass("inactive").addClass("active");
                $("#player_2").removeClass("active").addClass("inactive");
              }
              else {
                $("#player_1").removeClass("active").addClass("inactive");
                $("#player_2").removeClass("inactive").addClass("active");
              }
            }

            function drop(img, row, col) {
              img.css("left", (col * 100 / NB_COL) + '%');
              img.css("top",  ((NB_ROW - 1 - row) * 100 / Math.max(NB_ROW, NB_COL)) + '%');
              img.show();
              //img.animate({top: ((5-y)*100/7)+"%"}, 400, "linear", show_win);
            }

            function mark_win(x, y, dx, dy) {
              for (var i = 0; i < 4; i++) {
                mark[i].css("left", ((x + i * dx)*100/7) + '%');
                mark[i].css("top", ((5 - (y + i * dy))*100/7) + '%');
              }
            }

            function show_win() {
              if(won) {
                for(var i = 0; i < 4; i++) {
                  mark[i].show();
                }
              }
            }

            function win() {
              var x = moves[moves.length - 1];
              var y = height[x] - 1;

              if (y >= 3 && board[x][y - 3] == board[x][y] && board[x][y - 2] == board[x][y] && board[x][y - 1] == board[x][y]) {
                mark_win(x, y, 0, -1);
                won = true;
              }
              for (var dy = -1; dy <= 1; dy++) {
                var nb = 0;
                for (var dx = 1; x + dx < 7 && y + dx * dy < 6 && y + dx * dy >= 0; dx++)
                  if (board[x + dx][y + dx * dy] == board[x][y]) nb++;
                  else break;
                for (var dx = -1; x + dx >= 0 && y + dx * dy < 6 && y + dx * dy >= 0; dx--)
                  if (board[x + dx][y + dx * dy] == board[x][y]) nb++;
                  else break;
                if (nb >= 3) {
                  mark_win(x + dx + 1, y + (dx + 1) * dy, 1, dy);
                  won = true;
                }
              }
            }

            function get_pos() {
              var pos = "";
              for (var i = 0; i < moves.length; i++) pos = pos + (moves[i] + 1);
              return pos;
            }

            function get_pos_param() {
              var pos=get_pos();
              if(pos == "") return location.pathname;
              else return "?pos=" + pos;
            }

            function print_solution() {
                return; // TBD MGOUIN
              print_next_player();

              if(won) {
                var player = moves.length%2 == 0 ? "Yellow" : "Red";
                var message = "[1] won".replace("[1]", player);
                $("#solution_header").text(message);
                $(".solution").text("").css("background-image","none");
                return;
              }
              if(moves.length == 42) {
                var message = "Draw game";
                $("#solution_header").text(message);
                $(".solution").text("").css("background-image","none");
                return;
              }

              var json = solutions[moves.length];
              if(json === undefined || json.pos !== get_pos()) { //TODO check != ??
                compute_solution();
                return;
              }

              if(auto_play()) {
                var best = -100;
                var possible = [];
                for (var i = 0; i < 7; i++)
                  if(json.score[i] != 100 && json.score[i] > best) {
                    best = json.score[i];
                    possible = [i];
                  }
                  else if(json.score[i] == best) possible.push(i);

                var col = possible[Math.floor((Math.random() * possible.length))];
                play(col);
              }

              else {

                var best = -100;
                for (var i = 0; i < 7; i++)
                  if(json.score[i] != 100 && json.score[i] > best) best = json.score[i];

                var nb_best = 0;
                for (var i = 0; i < 7; i++)
                  if(best == 0 && json.score[i] == 0) nb_best++;
                  else if(best > 0 && json.score[i] > 0 && json.score[i] != 100) nb_best++;



                for (var i = 0; i < 7; i++) {
                  if(json.score[i] == 100) {
                    $("#sol" + i).text("").css("background-image","none");
                  }
                  else {
                    $("#sol" + i).text(json.score[i]);
                    if(json.score[i] > 0) {
                      if(json.score[i] == best) $("#sol" + i).css("background-image","url(up_star.png)");
                      else $("#sol" + i).css("background-image","url(up.png)");
                    }
                    else if(json.score[i] < 0) {
                      if(json.score[i] == best) $("#sol" + i).css("background-image","url(down_star.png)");
                      else $("#sol" + i).css("background-image","url(down.png)");
                    }
                    else {
                      if(json.score[i] == best) $("#sol" + i).css("background-image","url(neutral_star.png)");
                      else $("#sol" + i).css("background-image","url(neutral.png)");
                    }
                  }
                }

                var message;
                if(best > 0) {
                  var nb_moves = Math.floor((45 - moves.length)/2) - best;
                  if(nb_moves > 1) message = "[1] can win in [2] moves".replace("[2]", nb_moves);
                  else message = "[1] can win in 1 move";
                }
                else if(best < 0) {
                  var nb_moves = Math.floor((44 - moves.length)/2) + best;
                  if(nb_moves > 1) message = "[1] loses in [2] moves".replace("[2]", nb_moves);
                  else message = "[1] loses in 1 move";
                }
                else {
                  message = "[1] can draw";
                }

                var player = moves.length%2 == 0 ? "Red" : "Yellow";
                $("#solution_header").text(message.replace("[1]", player));

              }
            }

            function compute_solution() {
                // TBD MGouin
                return;

              $("#solution_header").text("computing solution... ");
              $(".solution").text("").css("background-image","none");
              $.getJSON("/solve", {pos: get_pos()}, function(json) {
                  solutions[json.pos.length] = json;
                  print_solution();
                  });
            }

            function back(event) {
              if (moves.length > 0) {
                var col = moves.pop();
                height[col]--;
                stone[moves.length].hide();
                board[col][height[col]] = 0;
                if (won) {
                  won = false;
                  $(".win").hide();
                }
                if(auto_play())
                  back();
                else {
                  print_solution();
                  if(event == undefined) history.replaceState(null, null, get_pos_param());
                  else history.pushState(null, null, get_pos_param());
                }
              }
              else if(auto_play()) {
                print_solution();
              }
            }

            function query_param(key) {
                var match = location.search.match(new RegExp("[?&]"+key+"=([^&]+)(&|$)"));
                return (match == null) ? "" : match[1];
            }

            function reset() {
              if(moves.length > 0) {
                moves = [];
                for (var i = 0; i < NB_ROW; i++) {
                  for (var j = 0; j < NB_COL; j++) {
                    board[i][j] = 0;
                  }
                }
                won = false;
                // $(".win").hide();
                $(".player1").hide();
                $(".player1h").hide();
                $(".player1v").hide();
                $(".player2").hide();
                $(".player2h").hide();
                $(".player2v").hide();
                //print_solution();
                //history.replaceState(null, null, get_pos_param());
              }
            }

            function isOdd(x) {
                return x % 2 != 0;
            }

            function isEven(x) {
                return !isOdd(x);
            }

            function getPositionType(row, col) {
                if (isOdd(row) && isEven(col))
                    return "board_pin_red";
                if (isEven(row) && isOdd(col))
                    return "board_pin_white";
                return "board";
            }

            function init() {
              for (var i = 0; i < NB_ROW; i++) {
                for (var j = 0; j < NB_COL; j++) {
                  var v = $("<div/>");
                  v.addClass(getPositionType(i, j));
                  v.css("left", (j * 100 / NB_COL) + '%');
                  v.css("top",  ((NB_ROW - 1 - i) * 100 / Math.max(NB_ROW, NB_COL)) + '%');
                  if (getPositionType(i, j) == "board") {
                      v.click(click_handler(i, j));
                  }
                  v.appendTo("#board");
                }
              }

              for (var i = 0; i < Math.ceil((NB_ROW * NB_COL) / 2); i++) {
                var v = $("<div/>");
                if (i % 2 === 0) v.addClass("player1h");
                else v.addClass("player2h");
                v.hide();
                v.appendTo("#board");
                stone_h[i] = v;
              }

              for (var i = 0; i < Math.ceil((NB_ROW * NB_COL) / 2); i++) {
                var v = $("<div/>");
                if (i % 2 === 0) v.addClass("player1v");
                else v.addClass("player2v");
                v.hide();
                v.appendTo("#board");
                stone_v[i] = v;
              }

              //print_solution();
            }

            function about() {
              $("#about_div").fadeToggle();
            }

            function toggle_solution() {
              $("#hide_solution_div").fadeToggle();
            }

            function toggle_player1() {
              if(player_1_auto) {
                $("#player_1").text("manual");
                player_1_auto = false;
              }
              else {
                $("#player_1").text("auto");
                $("#player_2").text("manual");
                player_1_auto = true;
                player_2_auto = false;
                print_solution();
              }
            }

            function toggle_player2() {
              if(player_2_auto) {
                $("#player_2").text("manual");
                player_2_auto = false;
              }
              else {
                $("#player_2").text("auto");
                $("#player_1").text("manual");
                player_2_auto = true;
                player_1_auto = false;
                print_solution();
              }
            }

            $(window).on('load', function(){init();});

            //]]>
        </script>
    </head>

    <body>
        <div id="container">
            <div id="nav" class="ui-widget">
                <div id="title"><h1>Connections</h1></div>
                <div id="description">2 ways to win:
                    <ul>
                        <li>Surround the opposing colour with your chips</li>
                        <li>Build a line of your colour end to end of the grid</li>
                    </ul>
                </div>

                <div id="button_div">
                    <!-- TBD MGouin: 
                    <div id="about" onclick="about()" class="button">about</div>
                    -->
                    <div id="new" onclick="reset()" class="button">new</div>
                    <!-- TBD MGouin: 
                    <div id="back" onclick="back()" class="button">back</div>
                    -->
                </div>
                <div id="player_div">
                    <!-- onclick="toggle_player1() -->
                    <div id="player_1" class="button active">manual</div>
                    <div id="player_2" class="button inactive">manual</div>
                </div>
            </div>

            <div id="board">
            </div>

            <!-- TBD MGouin:
            <div id="about_div" onclick="about()">
                <h4>Rules of the Game</h4>
                <p><a href="https://en.wikipedia.org/wiki/Connect_Four">Connect Four</a> (or <em>Four in a Row</em>) is a two-player strategy game. Each player takes turns dropping a chip of his color into a column. The first player to align four chips wins.</p>

                <h4>History</h4>
                <p>The Connect 4 game is a solved strategy game: the first player (Red) has a winning strategy allowing him to always win. The game has been independently solved by James Dow Allen and Victor Allis in 1988.</p>

                <h4>Connect 4 Solver</h4>
                <p>This Connect 4 solver computes the exact outcome of any position assuming both players play perfectly. A score can be displayed for each playable column: winning moves have a positive score and losing moves have a negative score. The absolute value of the score gives you the number of moves <em>before</em> the end of the game. Hence the best moves have the highest scores. You can play against the Artificial Intelligence by toggling the manual/auto mode of a player.</p>

                <h4>The Algorithm</h4>
                <p>The solver uses <a href="https://en.wikipedia.org/wiki/Alpha%E2%80%93beta_pruning">alpha beta pruning</a>. You can read the following tutorial (with source code) explaining <a href="http://blog.gamesolver.org/">how to solve Connect Four</a>.</p>

                <h4>The Author: <a href="https://fr.linkedin.com/in/pascalpons">Pascal Pons</a></h4>
                <p>Do not hesitate to send me comments, suggestions, or bug reports at <a href="mailto:connect4@gamesolver.org">connect4@gamesolver.org</a>.</p>

                <h4>Translation</h4>
                <p>You can contribute to the translation of this website in other languages by providing a translated version of this <a href="https://connect4.gamesolver.org/i18n.properties">localization file</a>. A big thank you to the translators: </p><ul><li>(RU) Slava</li><li>(TR) <a href="https://github.com/ek33">Ekrem</a></li><li>(SE) Speeder</li><li>(PT) Nhaar</li><li>(ES) Francisco</li><li>(DE) Lenny5156</li><li>(ZH) Michael</li></ul><p></p>
            </div>
            -->

        </div>
    </body>
</html>
